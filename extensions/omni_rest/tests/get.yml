$schema: "https://raw.githubusercontent.com/omnigres/omnigres/master/pg_yregress/schema.json"
instance:
  config:
    shared_preload_libraries: */env/OMNI_SO
    max_worker_processes: 64
  init:
  - set session omni_httpd.init_port = 0
  - create extension omni_httpd cascade
  - create extension omni_httpc cascade
  # FIXME: waiting for two reloads is working around a startup bug in omni_httpd
  - call omni_httpd.wait_for_configuration_reloads(2)
  - create extension omni_rest cascade
  - |
    create
        or
        replace function omni_httpd.handler(int, omni_httpd.http_request) returns omni_httpd.http_outcome
        language plpgsql
    as
    $$
    declare
        req omni_httpd.http_request;
    begin
        req := $2;
        return coalesce(omni_rest.postgrest(req),
                        omni_rest.handler(omni_rest.fallback_route(req)));
    end;
    $$
  - |
    create table users
    (
        id           serial primary key,
        name         text,
        email        text,
        profile_info jsonb
    )
  - insert into users (id, name, email, profile_info)
    values (1, 'John Doe', 'john@doe.com',
            jsonb_build_object('bio', 'Software industry veteran', 'tags', jsonb_build_array('ci', 'postgres')))
  - |
    create function make_request(path text, method omni_http.http_method default 'GET') returns setof omni_httpc.http_response
        language sql as
    $$
    select *
    from omni_httpc.http_execute(
            omni_httpc.http_request('http://127.0.0.1:' ||
                                    (select effective_port from omni_httpd.listeners) ||
                                    path, method => method))
    $$
  - |
    create function first_name(users) returns text
        language sql as
    $$
    select split_part($1.name, ' ', 1)
    $$;

tests:

- name: simple listing
  query: |
    with response as (select * from make_request('/users'))
    select response.status,
           (select json_agg(json_build_object(h.name, h.value))
            from unnest(response.headers) h
            where h.name not in ('server', 'content-length', 'connection')) as headers,
           convert_from(response.body, 'utf-8')::json                       as body
    from response
  results:
  - status: 200
    headers:
    - content-range: 0-1/*
    - content-type: application/json
    body:
    - id: 1
      name: John Doe
      email: john@doe.com
      profile_info:
        bio: Software industry veteran
        tags:
        - ci
        - postgres

- name: basic vertical filtering
  query: |
    with response as (select * from make_request('/users?select=email,name'))
    select response.status,
           (select json_agg(json_build_object(h.name, h.value))
            from unnest(response.headers) h
            where h.name not in ('server', 'content-length', 'connection')) as headers,
           convert_from(response.body, 'utf-8')::json                       as body
    from response
  results:
  - status: 200
    headers:
    - content-range: 0-1/*
    - content-type: application/json
    body:
    - name: John Doe
      email: john@doe.com

- name: column renaming
  query: |
    with response as (select * from make_request('/users?select=name:fullName'))
    select response.status,
           (select json_agg(json_build_object(h.name, h.value))
            from unnest(response.headers) h
            where h.name not in ('server', 'content-length', 'connection')) as headers,
           convert_from(response.body, 'utf-8')::json                       as body
    from response
  results:
  - status: 200
    headers:
    - content-range: 0-1/*
    - content-type: application/json
    body:
    - fullName: John Doe

- name: computed field
  query: |
    with response as (select * from make_request('/users?select=first_name'))
    select response.status,
           (select json_agg(json_build_object(h.name, h.value))
            from unnest(response.headers) h
            where h.name not in ('server', 'content-length', 'connection')) as headers,
           convert_from(response.body, 'utf-8')::json                       as body
    from response
  results:
  - status: 200
    headers:
    - content-range: 0-1/*
    - content-type: application/json
    body:
    - first_name: John

- name: JSON access
  query: |
    with response as (select * from make_request('/users?select=profile_info->bio,profile_info->tags->0:firstTag'))
    select response.status,
           (select json_agg(json_build_object(h.name, h.value))
            from unnest(response.headers) h
            where h.name not in ('server', 'content-length', 'connection')) as headers,
           convert_from(response.body, 'utf-8')::json                       as body
    from response
  results:
  - status: 200
    headers:
    - content-range: 0-1/*
    - content-type: application/json
    body:
    - bio: Software industry veteran
      firstTag: ci
